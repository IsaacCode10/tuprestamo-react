<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oportunidades de Inversión – Tu Préstamo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Estilos específicos para esta página */
    .dashboard-header {
      padding: 2rem 0;
      background-color: var(--light-alt-bg);
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    .oportunidades-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      padding: 2rem 0;
    }
    .oportunidad-card {
      background: var(--white);
      border: 1px solid #e0e0e0;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: auto; /* Ajuste para contenido dinámico */
    }
    .oportunidad-card__body {
      padding: 1rem 1.5rem;
      flex-grow: 1;
    }
    .oportunidad-card__title {
      font-family: var(--font-head);
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
    }
    .info-row strong {
      color: var(--primary-color);
    }
    .progress-bar {
      background-color: #e0e0e0;
      border-radius: 10px;
      height: 10px;
      margin-top: 1rem;
    }
    .progress-bar__inner {
      background-color: var(--accent-color);
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease-in-out; /* Animación de la barra de progreso */
    }
    .oportunidad-card__footer {
      background-color: var(--light-alt-bg);
      padding: 1rem 1.5rem;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column; /* Apilar en móvil */
      gap: 0.5rem;
      align-items: center;
    }
    .investment-input {
      width: 100%; /* Ocupar todo el ancho disponible */
      max-width: 120px; /* Limitar ancho en desktop */
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      text-align: center;
    }
    /* Mensaje de carga/error */
    #loading-message, #error-message {
      text-align: center;
      padding: 2rem;
      font-size: 1.1rem;
      color: var(--primary-color);
    }
    /* Responsive adjustments for footer */
    .footer {
        padding: 1rem 0; /* Reduced padding */
        text-align: center;
        background-color: var(--primary-color); /* Darker background */
        color: var(--white);
    }
    .footer .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    .footer__text {
        font-size: 0.8rem;
    }

    @media (min-width: 768px) {
      .oportunidad-card__footer {
        flex-direction: row; /* Volver a fila en desktop */
        justify-content: space-between;
      }
      .investment-input {
        width: auto; /* Vuelve a auto para respetar max-width */
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header__inner">
      <a href="INDEXTUPRESTAMO.HTML" class="logo-link"><img src="logo-tu-prestamo.png" alt="Logo Tu Préstamo" class="logo" /></a>
      <nav class="nav">
        <ul class="nav__list">
          <li class="nav__item"><a href="#" class="nav__link" id="user-code-display"></a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="dashboard-header">
      <div class="container">
        <h1 class="section__title">Oportunidades de Inversión</h1>
        <p class="section__text">Aquí se listan las solicitudes de refinanciamiento que han sido aprobadas por nuestro equipo. Elige en cuáles quieres invertir.</p>
      </div>
    </section>

    <section class="container">
      <div id="loading-message">Cargando oportunidades...</div>
      <div id="error-message" style="display:none;"></div>
      <div class="oportunidades-grid" id="oportunidades-grid">
        <!-- Las oportunidades se cargarán aquí dinámicamente -->
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
        <p class="footer__text">&copy; 2025 Tu Préstamo. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    // URL de tu Web App de Google Apps Script (¡CAMBIA ESTO!)
    // Esta es la misma URL que ya usas para doGet(), pero ahora también usará doPost()
    const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXAETJQKe3jEaQmDn80MgCJsdVIdNJjlnomZ3vefc_UPAyVjsL0kMtF-pzSzdm_KxsWQ/exec'; // Pega la URL obtenida en el paso 2.4 del despliegue

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const userCode = params.get('user'); // Si pasas algún ID de usuario desde el login, puedes usarlo aquí

      // Para el MVP, si el usuario llega aquí desde el login con correo
      // podrías pasar el correo en la URL como un parámetro 'email'
      // Por ejemplo: oportunidades.html?user=ID_USER&email=usuario@ejemplo.com
      const userEmail = params.get('email');

      if (userCode) {
        document.getElementById('user-code-display').textContent = `Inversionista: ${userCode}`;
      } else if (userEmail) {
         // Si no hay userCode pero hay email, mostrar el email
         document.getElementById('user-code-display').textContent = `Inversionista: ${userEmail}`;
      }


      fetchOportunidades();
    });

    async function fetchOportunidades() {
      const grid = document.getElementById('oportunidades-grid');
      const loadingMessage = document.getElementById('loading-message');
      const errorMessage = document.getElementById('error-message');

      loadingMessage.style.display = 'block';
      errorMessage.style.display = 'none';
      grid.innerHTML = ''; // Limpiar el grid antes de cargar

      try {
        const response = await fetch(GOOGLE_APP_SCRIPT_URL);
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        const data = await response.json();

        loadingMessage.style.display = 'none';

        if (data.error) {
          errorMessage.textContent = `Error al cargar oportunidades: ${data.error}`;
          errorMessage.style.display = 'block';
          return;
        }

        if (data.length === 0) {
          grid.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 2rem;">No hay oportunidades de inversión disponibles en este momento. Vuelve pronto.</p>';
          return;
        }

        data.forEach(oportunidad => {
          const fondeadoPorcentaje = (oportunidad.Fondeado_Actual / oportunidad.Fondeado_Total) * 100;
          const card = `
            <div class="oportunidad-card">
              <div class="oportunidad-card__body">
                <h3 class="oportunidad-card__title">Solicitud de Refinanciamiento #${oportunidad.ID_Solicitud}</h3>
                <div class="info-row"><span>Monto a Refinanciar:</span> <strong>Bs ${new Intl.NumberFormat('es-BO').format(oportunidad.Monto_Refinanciar)}</strong></div>
                <div class="info-row"><span>Tasa Anual (Rendimiento):</span> <strong>${oportunidad.Tasa_Anual_Rendimiento}%</strong></div>
                <div class="info-row"><span>Plazo:</span> <strong>${oportunidad.Plazo_Meses} meses</strong></div>
                <div class="info-row"><span>Nivel de Riesgo:</span> <strong>${oportunidad.Nivel_Riesgo}</strong></div>
                <div class="progress-bar">
                  <div class="progress-bar__inner" style="width: ${fondeadoPorcentaje}%;"></div>
                </div>
                <div class="info-row" style="margin-top: 0.5rem;"><span>Fondeado:</span> <strong>Bs ${new Intl.NumberFormat('es-BO').format(oportunidad.Fondeado_Actual)} de Bs ${new Intl.NumberFormat('es-BO').format(oportunidad.Fondeado_Total)}</strong></div>
              </div>
              <div class="oportunidad-card__footer">
                <input type="number" class="investment-input" placeholder="Monto" min="350" step="50" id="input-${oportunidad.ID_Solicitud}">
                <button class="btn btn--primary" onclick="invertir('${oportunidad.ID_Solicitud}')">Invertir</button>
              </div>
            </div>
          `;
          grid.insertAdjacentHTML('beforeend', card);
        });

      } catch (error) {
        loadingMessage.style.display = 'none';
        errorMessage.textContent = `No se pudieron cargar las oportunidades. Intenta de nuevo más tarde. (Detalle: ${error.message})`;
        errorMessage.style.display = 'block';
        console.error('Error fetching opportunities:', error);
      }
    }
async function invertir(idSolicitud) {
  const inputElement = document.getElementById(`input-${idSolicitud}`);
  const monto = parseInt(inputElement.value);

  if (isNaN(monto) || monto < 350) {
    alert('Por favor, ingresa un monto válido para invertir (mínimo Bs 350).');
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const userEmail = params.get('email') || 'anonimo@example.com';

  const confirmacion = confirm(`¿Estás seguro que deseas invertir Bs ${new Intl.NumberFormat('es-BO').format(monto)} en la solicitud #${idSolicitud}?`);
  if (!confirmacion) {
    return;
  }

  try {
    const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        idSolicitud: idSolicitud,
        monto: monto,
        email: userEmail
      }),
    });

    // === AGREGADO PARA DEPURACIÓN ===
    if (!response.ok) {
        const errorText = await response.text(); // Intenta leer el cuerpo como texto si no fue OK
        console.error('Error HTTP en la respuesta:', response.status, response.statusText, 'Cuerpo:', errorText);
        throw new Error(`Error de servidor: ${response.status} ${response.statusText} - ${errorText.substring(0, 100)}...`);
    }
    // === FIN AGREGADO ===

    // Esto podría fallar si la respuesta no es un JSON válido
    const result = await response.json();

    if (result.status === 'success') {
      alert('¡Tu interés de inversión ha sido registrado con éxito! Nos pondremos en contacto contigo para los siguientes pasos.');
      inputElement.value = '';
    } else {
      alert(`Error al registrar tu inversión: ${result.message}`);
      console.error('Error en el registro de inversión (respuesta de Apps Script):', result.message);
    }
  } catch (error) {
    alert('Hubo un problema al conectar con el servidor. Intenta de nuevo.');
    console.error('Error enviando inversión (problema de red o parsing):', error);
  }
}
  </script>
</body>
</html>
