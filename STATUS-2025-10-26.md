# Estado del Proyecto - 26 de Octubre de 2025

Asunto: Bug en subida de documentos (Prestatario) — Edge Function `analizar-documento-v2` responde 500

Resumen: La carga y análisis de documentos falla con 500 desde el frontend. En logs de la Edge Function se observa llamada a Gemini y respuesta HTTP recibida, pero la API devuelve 400 INVALID_ARGUMENT: "API key not valid". Se actualizó `GEMINI_API_KEY` en Supabase Secrets (copiada de Google AI Studio) y el error persiste.

Hechos verificados
- Frontend: error 500 al invocar `functions/v1/analizar-documento-v2`.
- Edge logs: "Paso 1: Llamando a la API de Gemini..." seguido de "Paso 2: Respuesta ..." y luego `Error en la API de Gemini: 400 ... API key not valid`.
- Secrets en Supabase: `GEMINI_API_KEY` presente y recientemente actualizada; también `GEMINI_MODEL` definido.
- Código actual usa REST de AI Studio: `POST https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=...` con `inlineData` (base64 del archivo).

Acciones realizadas hoy
- Reemplazo de `GEMINI_API_KEY` por nueva de Google AI Studio en Edge Function Secrets.
- Reintentos de invocación posterior al update; persiste `400 API_KEY_INVALID` desde Gemini.

Observaciones del código
- Bloque de normalización de modelo contiene una línea de log corrupta (encoding) alrededor de `console.log(...)`, sin relación directa con el 400 pero conviene saneo de logs y validación suave del formato de la key.
- El flujo de logs puede confundir: "Paso 2: Respuesta ..." indica recepción HTTP, no éxito de la operación.

Hipótesis activas (causas probables)
- Key inválida o proyecto sin "Generative Language API" habilitada para esa key.
- Restricciones de la API Key (p.ej. HTTP referrer) incompatibles con uso server-side.
- Error de pegado (espacios/saltos/quotes) poco probable pero considerado; ya se reingresó.

Siguientes pasos propuestos
- Sanity check fuera de Supabase (aislar key):
  curl -X POST "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=TU_KEY" -H "Content-Type: application/json" -d '{"contents":[{"parts":[{"text":"ping"}]}]}'
  - Si responde 200 con `candidates` → la key sirve; revisar función/logs.
  - Si responde 400 "API key not valid" → revisar en GCP: habilitar "Generative Language API" y restricciones de la key.
- Saneamiento de función (pendiente de aplicar):
  - Validación suave: `GEMINI_API_KEY` debe iniciar con `AIza` y log seguro del modelo.
  - Corregir logs: "Paso 2: Respuesta HTTP de Gemini recibida" y limpiar línea corrupta.

Estado: Bloqueado por `API_KEY_INVALID` reportado por Gemini. A la espera de recomendación de Gemini Code Assist para desbloquear.

