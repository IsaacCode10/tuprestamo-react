# Estado del Proyecto ó 10 Nov 2025 (Noche)
Vigente: 2025-11-10

ConvenciÛn
- Mantener solo pendientes/QA del bloque vigente.

Resumen
- Resumen (Borrower): tarjetas KPI en una fila; ìTasa Propuesta (anual)î; unificaciÛn de ìCuota Mensualî.
- C·lculos: helper com˙n con polÌtica V1 (=10k Bs ? 450 fijo; >10k ? % con gross-up) + admin/seguro 0,15% (mÌn. 10). Afecta Resumen y Propuesta.
- Propuesta de Ahorro: corregidos ìCosto Admin. y Seguroî, ìComisiÛn por OriginaciÛnî, y Transparencia Total (Con Tu PrÈstamo).
- AmortizaciÛn: generaciÛn autom·tica al estado inanciado + lectura/render en dashboard.
- DocumentaciÛn: flujo ìAutorizaciÛn INFOCRED (requisito ASFI)î con descarga de PDF pre-relleno y subida de versiÛn firmada a mano; se muestra al final y se habilita cuando el resto est· completo.
- Funciones: handle-new-solicitud genera utorizacion_infocred_preimpresa.pdf y lo registra para descarga.

ProducciÛn
- Frontend desplegado en Vercel (˙ltimo deploy activo OK).
- Supabase Functions desplegadas en paijuvlccnkxjwjpoffe.

Cambios por archivo (clave)
- src/utils/loan.js: calcOriginacionYBruto, calcCuotaMensualTP, calcTPBreakdown.
- src/components/SavingsCalculator.jsx: usa breakdown com˙n; ìCuota Mensualî.
- src/BorrowerDashboard.jsx/.css: KPI row, tooltips, tn--sm; autorizaciÛn INFOCRED (descarga + subida final y gating).
- supabase/functions/handle-new-solicitud/index.ts: genera y registra PDF pre-relleno.

Pendientes / QA
1) PDF pre-impreso en solicitudes previas: probar con solicitud nueva; si se requiere backfill on-demand, agregar endpoint de generaciÛn manual.
2) QA responsive (mÛvil): tamaÒos de KPI y bloque de autorizaciÛn; accesibilidad del tooltip.
3) Validar c·lculo ìCuota Mensualî con casos lÌmite: neto 10k/10.001/70k; tasas 15/17/20; plazos 12/18/24.
4) Verificar trigger de amortizaciÛn y lectura cuando oportunidades ? inanciado en un flujo real.
5) AnalÌtica: instrumentar Downloaded Authorization PDF y Uploaded Signed Authorization.
6) Opcional: badge ìASFIî junto al tÌtulo de autorizaciÛn.

---
# Estado del Proyecto ‚Äî 7 Nov 2025 (Tarde)
Vigente: 2025-11-07

Convenci√≥n de actualizaci√≥n
- Mantener este bloque como vigente (√∫ltima fecha).
- Borrar lo ya implementado; solo listar pendientes/QA actuales.
- Opcional: mover el bloque anterior a ‚ÄúHistorial ‚Äî <fecha>‚Äù.

Resumen
- Landing: Hero restaurado (refinanci√° con mejores tasas), se elimin√≥ ‚ÄúComparativa‚Äù, Beneficios con √≠conos y grilla 3+2 centrada, SEO actualizado.
- Men√∫ m√≥vil: overlay lateral robusto (bloqueo de scroll, foco, Escape, trap de Tab); fixes de visibilidad y altura (auto/max-height, borde redondeado).
- C√≥mo Funciona: sin marcas de terceros; desembolso dirigido al banco; originaci√≥n por nivel A 3% / B 4% / C 5%; CSS incluido para build.
- FAQ Inversionista: modelo no-custodia (sin ‚ÄúFondos disponibles‚Äù/‚ÄúRetiros‚Äù); sin breadcrumbs/back cuando no hay sesi√≥n.
- Legales: Privacidad y T√©rminos sin placeholders de ‚Äú√öltima actualizaci√≥n‚Äù ni stack tecnol√≥gico; Ley aplicable: Bolivia.
- Infra: build corregido (faltante `src/components/ComoFunciona.css`).

Producci√≥n
- URL activa: https://tuprestamo-react-a0y2o8gpt-isaac-alfaros-projects.vercel.app

Cambios por archivo
- `src/components/Header.css`: estilos para `.mobile-menu-overlay` y `.mobile-menu-panel` (slide-in, sombras) y elementos del men√∫ m√≥vil.
- `src/components/Header.jsx`: mejoras de a11y (foco, Escape, trap, scroll lock) y estructura del panel m√≥vil.
- `src/components/ComoFunciona.css`: layout m√≥vil con tarjetas apiladas (100% ancho, padding 16px, radius, shadow).
- `src/components/ComoFunciona.jsx`: import de estilos m√≥viles.
- `src/components/AuthLinker.jsx`: nuevo componente de vinculaci√≥n de identidades (Google) v√≠a Supabase Auth v2.
- `src/InvestorProfile.jsx`, `src/Profile.jsx`: integraci√≥n de `AuthLinker` bajo la secci√≥n ‚ÄúSeguridad‚Äù.

Pendientes (Supabase Dashboard ‚Äî requeridos)
1) Activar proveedor Google (Authentication ‚Üí Providers ‚Üí Google ‚Üí ON).
2) Configurar Client ID/Secret de Google y autorizar redirect: `https://<PROJECT-REF>.supabase.co/auth/v1/callback`.
3) Authentication ‚Üí Settings: Site URL (dominio Vercel prod), Additional Redirect URLs (previews de Vercel + `http://localhost:5173`).
4) Activar ‚ÄúAllow linking of multiple identities‚Äù.

QA sugerido
- Vincular Google desde Perfil: listar identidades, vincular, confirmar retorno a la app, ver m√©todo en la lista.
- Desvincular: no permitir si quedar√≠a la cuenta sin m√©todo o si es email/password.
- Men√∫ m√≥vil: abrir/cerrar, bloqueo de scroll, Escape y navegaci√≥n por Tab dentro del panel; sin ‚Äúespacio blanco‚Äù extra.
- ‚ÄúC√≥mo Funciona‚Äù (m√≥vil): 5 tarjetas apiladas, tipograf√≠a legible y spacing correcto.

Pendientes E2E (lanzamiento)
- E2E Inversionista
  - Registro/inicio sin sesi√≥n ‚Üí ver Landing correcta (Hero/Beneficios).
  - KYC completo ‚Üí estado verificado persiste; sin breadcrumbs/back en FAQ si no hay sesi√≥n.
  - Explorar Oportunidades ‚Üí invertir (m√≠n. Bs 700) ‚Üí al 100%: flujo marca financiada.
  - Pagos: en cada ciclo, transferencia autom√°tica del neto a cuenta bancaria (no hay ‚ÄúRetiros‚Äù ni ‚ÄúFondos disponibles‚Äù).
  - Notificaciones: creaci√≥n y lectura manual (no auto-le√≠das).

- E2E Prestatario
  - Solicitud ‚Üí verificaci√≥n de saldo deudor ‚Üí c√°lculo gross-up seg√∫n nivel (A/B/C).
  - Aprobaci√≥n ‚Üí fondeo ‚Üí desembolso dirigido al banco acreedor (no a la cuenta del prestatario).
  - Amortizaci√≥n: generar tabla (ejecutar `sql/amortizacion.sql` y `generate_amortizacion(...)`).
  - Dashboard prestatario: CTA ‚ÄúPago Extra‚Äù (registro de intenci√≥n) y UX estable.

Siguientes pasos (opcionales)
- Pantalla de Auth: a√±adir bot√≥n ‚ÄúContinuar con Google‚Äù (sign-in social est√°ndar).
- Header: exponer `aria-expanded`/`aria-controls` en el bot√≥n y animar a ‚ÄúX‚Äù al abrir.
- Apple Sign-in: planificar setup (Service ID, Team ID, Key ID, Private Key) y habilitar provider.

Nota
Este STATUS reemplaza versiones previas extensas. Mantenerlo breve y accionable a partir de ahora.

---

## Historial ‚Äî 3 Nov 2025 (Noche)

Resumen r√°pido

- KYC inversionista estable: el estado se mantiene en ‚ÄúVerificada‚Äù, sin regresiones.
- Notificaciones restauradas: Toast autom√°tico en dashboard y badge rojo en el header.
- Cuenta bancaria: se promueve desde `verification_drafts` a `cuentas_bancarias_inversionistas` al quedar verificado.
- Auditor√≠a OCR: se registra en `analisis_documentos` (proveedor + datos extra√≠dos) tras la verificaci√≥n.
- Despliegues: Supabase Functions y Vercel en producci√≥n actualizados.

Siguiente E2E (ma√±ana)

- Repetir flujo completo: registro ‚Üí verificaci√≥n CI ‚Üí correo con CTA ‚Üí dashboard con Toast ‚Üí verificaci√≥n persiste ‚Üí cuenta bancaria creada/actualizada ‚Üí oportunidades visibles.
- Validar en DB: `analisis_documentos` y `cuentas_bancarias_inversionistas` contienen filas para el usuario verificado.

---

Resumen de hoy (flujo INVERSIONISTA)

- UI Oportunidades: filtros segmentados (Tasa 10/12/15, Plazo 12/18/24) con estilos Brand Kit.
- Dashboard (src/InvestorDashboard.jsx):
  - Corrige acentos y copy. Oculta la pill cuando estado = verificado.
  - Muestra Toast de KYC autom√°ticamente (sin abrir men√∫).
  - Suscripciones Realtime para perfil (UPDATE) y notificaciones (INSERT).
- Header (src/components/Header.jsx):
  - Badge rojo de notificaciones restablecido.
  - Ya no marca como le√≠das al abrir la campana; persisten hasta acci√≥n del usuario.
- Verificaci√≥n (supabase/functions/verificar-identidad-inversionista):
  - Idempotencia de notificaci√≥n (solo si cambi√≥ el estado v√≠a UPDATE RETURNING).
  - Inserta auditor√≠a en `analisis_documentos` (proveedor + datos extra√≠dos).
  - Si estado = ‚Äúverificado‚Äù: upsert de cuenta bancaria desde `verification_drafts` ‚Üí `cuentas_bancarias_inversionistas` (por `user_id`).
- Infra: redeploy de Functions (Supabase) y deploy de producci√≥n (Vercel).

---

Problemas abiertos (prioridad alta)

1) OCR KYC (mejora del prompt)
   - Extraer: `numero_ci`, `expiracion` (con meses literales), `candidatos_numero_ci`, `ocr_confidence`.
   - Normalizar fecha (p. ej., ‚Äú12 de abril de 2031‚Äù ‚Üí YYYY-MM-DD) y bloquear si expiraci√≥n vencida.

2) Revisi√≥n manual (cuando OCR falla)
   - Encolar en `public.kyc_review_queue` (crear tabla) y agregar panel admin m√≠nimo para aprobar/rechazar.

3) Email deliverability (unificaci√≥n remitente)
   - Unificar remitente en funciones a `notificaciones@tuprestamobo.com` (Reply-To `contacto@tuprestamobo.com`).
   - Revisar SPF/DKIM/DMARC y supresi√≥n en Resend.

4) Auditor√≠a OCR (enriquecimiento)
   - Guardar tambi√©n: `user_id`, `tipo_documento` y `url_archivo` en `analisis_documentos` para trazabilidad completa.

---

Flujo KYC inversionista (actual)

- Upload: CI a Storage/bucket `documentos-inversionistas`; ruta guardada en `verification_drafts`.
- Invocaci√≥n: Edge `verificar-identidad-inversionista` con `{ user_id, url_archivo, tipo_documento }`.
- Funci√≥n:
  - URL firmada; OCR con Gemini; parseo robusto de JSON.
  - Auditor√≠a: inserta en `analisis_documentos` (proveedor + datos extra√≠dos).
  - Actualiza `profiles.estado_verificacion` (idempotente) y notifica (in-app + email con CTA consistente).
  - Si estado = ‚Äúverificado‚Äù: upsert de cuenta bancaria en `cuentas_bancarias_inversionistas` desde `verification_drafts`.
- Front:
  - Dashboard: Toast autom√°tico; Realtime; pill oculta en ‚Äúverificado‚Äù.
  - Header: badge rojo visible al haber no le√≠das; no se auto-marcan como le√≠das.

---

Siguiente (para ma√±ana)

- Completar prompt OCR (expiraci√≥n/normalizaci√≥n/confidence) + bloqueo por vencimiento.
- Dise√±ar y crear `kyc_review_queue` + vista admin m√≠nima.
- Unificar remitente emails y revisar entregabilidad en Resend.
- Enriquecer `analisis_documentos` con `user_id`/`tipo_documento`/`url_archivo`.

Notas de Configuraci√≥n

- Storage: bucket privado `documentos-inversionistas` (RLS apropiadas).
- Secrets Functions: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `RESEND_API_KEY`, `APP_BASE_URL`, `GEMINI_API_KEY`/`GOOGLE_GEMINI_API_KEY`.

Enlaces √∫tiles

- Portafolio: `/mis-inversiones`
- Retiros: `/retiro`
- Landing ‚ÄúQuiero Invertir‚Äù: `/`
- Edge Functions: `verificar-identidad-inversionista`, `handle-new-solicitud`, `save-investor-lead`, `create-notification`

---

## Actualizacion ‚Äî 7 Nov 2025 (Noche)

Implementado hoy
- Branding meta/OG/Twitter corregido y assets public agregados (SEO/preview).
- Landing: posicionamiento "Cero comisiones por pago anticipado" (Hero, Beneficios, Comparativa, FAQ).
- Prepagos (MVP): boton "Realizar Pago Extra" en dashboard del prestatario aprobado/desembolsado.
  - Modal con simulacion local (metodo frances): mantiene cuota y reduce plazo; muestra ahorro en intereses.
  - Registra intencion en tabla pagos_extra_solicitados (si existe) y evento analytics.
- SQL base: sql/amortizacion.sql con tablas mortizaciones y pagos_extra_solicitados + funcion generate_amortizacion(...).
- Google Sign-In: revertido en /auth y en activacion; se retomara con Custom Domain (Supabase Pro).

Pendientes inmediatos
- Ejecutar sql/amortizacion.sql en Supabase (SQL Editor) para crear tablas y funcion.
- Generar cronograma al "desembolsar" (ejecutar generate_amortizacion(...) manual o activar trigger opcional del script).
- Definir donde mostrar la tabla de amortizacion en el dashboard y leer public.amortizaciones.
- Mantener calculadoras sin logica de prepago (confirmado).

Rutas/archivos claves
- index.html, src/components/LandingPage.jsx
- src/components/Hero.jsx, src/components/Beneficios.jsx, src/components/Comparativa.jsx, src/components/FAQ.jsx
- src/BorrowerDashboard.jsx (CTA y modal), src/utils/amortization.js
- sql/amortizacion.sql


